<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>IRIS/Git Integration Settings</title>
<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
<link rel="stylesheet" type="text/css" href="css/git-webui.css" />
#(##class(SourceControl.Git.Utils).GetSourceControlInclude())#
<style type='text/css'>
.error {
    color: red;
}

body {
    font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
    font-size: 1rem;
    font-weight: 350;
    line-height: 1.5;
    color: #212529;
    text-align: left;
}

.btn-add {
    border:none;
    padding:0%;
    margin-left:0%;
    margin-top:-2%;
}
.btn-remove {
    border: 1px solid #ced4da;
    border-left: none;
    border-radius: 0 0.25rem 0.25rem 0;
}

#NoFolders {
    display: none;
}
#webuiURL {
    display: none;
}

.custom-switch {
    padding: 0.4rem 0.5rem 0 2.75rem;
    border: 1px solid #ced4da;
    border-left: 0px;
}
</style>
</head>
<body>
<server>
 new $namespace
 set namespace = %request.Data("NSpace",1)
 set $namespace = namespace
     
 set webuiURL = "/isc/studio/usertemplates/gitsourcecontrol/webuidriver.csp/"_$namespace_"/?CSPSHARE=1"
 set webuiURL = ##class(SourceControl.Git.WebUIDriver).GetURLPrefix(%request, webuiURL)
 
 set settings = ##class(SourceControl.Git.Settings).%New()

 if $Data(%request.Data("gitsettings",1)) {
    for param="gitBinPath","namespaceTemp","privateKeyFile","pullEventClass","percentClassReplace","gitUserName","gitUserEmail"{
        set $Property(settings,param) = $Get(%request.Data(param,1))
    }
    set i = 1
    set param = "NoFolders"
    kill settings.Mappings
    
    while ( $Get(%request.Data("MappingsExt",i)) '= "" ){
        if ($Get(%request.Data(param,i)) = "NoFolders"){
            set settings.Mappings($Get(%request.Data("MappingsExt",i)), $Get(%request.Data("MappingsCov",i)), $Get(%request.Data(param,i))) = 1
        }
        set settings.Mappings($Get(%request.Data("MappingsExt",i)), $Get(%request.Data("MappingsCov",i))) = $Get(%request.Data("MappingsPath",i))
        set i = i+1
    }
    do settings.%Save()
}
</server>
<div class = 'container'>
    <div class="col-sm-1"><br/></div>
    
    <form method='post'>
        <input type="hidden" name="NSpace" value="#(..EscapeHTML(namespace))#" />
        <input type="hidden" name="gitsettings" value="1" />
        <div class="col-sm-1"></div>
        <div class="row">
            <div class="col-sm-8">
                <h1>Git Project Settings</h1>
            </div>
            <div class="col-sm-2">
                <button class="btn btn-lg btn-outline-dark" id="goToWebUI">Go to WebUI
                </button>
                <div id="webuiURL">
                    #(webuiURL)#
                </div>
            </div>
        </div>
        <div class="col-md-10"><hr></div>
        <h3>Settings for namespace #(..EscapeHTML(namespace))#</h3><br/>

        <div class="form-group row mb-3">
            <label for="gitBinPath" class="col-sm-3 col-form-label"  data-toggle="tooltip" data-placement="top" title="Absolute path to the Git executable">Path to git.exe</label>
            <div class="col-sm-7">
                <server>
                    set exists = ##class(SourceControl.Git.Utils).GitBinExists(.version)
                    set placeholder = $Select($system.Version.GetOS()="Windows":"(e.g. C:\Program Files\Git\bin\git.exe)",
                        1:"(e.g., /usr/bin/git)")
                    if (exists && (settings.gitBinPath = "")) {
                        set placeholder = "(available via PATH at version shown below)"
                    }
                </server>
                <input type="text" class="form-control" id="gitBinPath" name="gitBinPath" value='#(..EscapeHTML(settings.gitBinPath))#' placeholder="#(placeholder)#">
                <csp:if condition="'$length(version)">
                    <p class="text-danger">File not found</p>
                <csp:else>
                    <p><em>#(version)#</em></p>
                </csp:else>
                </csp:if>
            </div>
        </div>

        <div class="form-group row mb-3">
            <label for="namespaceTemp" class="col-sm-3 col-form-label"  data-toggle="tooltip" data-placement="top" title="Absolute path to you project">Temp folder for this namespace<br/></label>
            <div class="col-sm-7">
                <input type="text" class="form-control" id="namespaceTemp" name="namespaceTemp" value='#(..EscapeHTML(settings.namespaceTemp))#' placeholder="e.g. C:\someproj\"/>
            </div>
        </div>

        <div class="form-group row mb-3">
            <label for="privateKeyFile" class="col-sm-3 col-form-label"  data-toggle="tooltip" data-placement="top" title="Absolute path to your private SSH key file">SSH Private Key File</label>
            <div class="col-sm-7">
                <input type="text" class="form-control" id="privateKeyFile" name="privateKeyFile" value='#(..EscapeHTML(settings.privateKeyFile))#' placeholder="C:\Users\ExampleUser\.ssh\id_rsa"/>
            </div>
        </div>

        <div class="form-group row mb-3">
            <label for="pullEventClass" class="col-sm-3 col-form-label"  data-toggle="tooltip" data-placement="top" title="Handler class for git pull">Pull Event Class</label>
            <div class="col-sm-7">
                <select class="form-control" id="pullEventClass" name="pullEventClass">
                    <option value="SourceControl.Git.PullEventHandler.Default" #($Case(settings.pullEventClass,"SourceControl.Git.PullEventHandler.Default":"selected",:""))#>Default</option>
                    <option value="SourceControl.Git.PullEventHandler.PackageManager" #($Case(settings.pullEventClass,"SourceControl.Git.PullEventHandler.PackageManager":"selected",:""))#>PackageManager</option>
                </select>
            </div>
        </div>

        <div class="form-group row mb-3">
            <label for="percentClassReplace" class="col-sm-3 col-form-label"  data-toggle="tooltip" data-placement="top" title="Character(s) to replace '%' with for percent classes while exporting them out to the filesystem. By default, the '%' is removed.">'%' Replacement on Export</label>
            <div class="col-sm-7">
                <input type="text" class="form-control" id="percentClassReplace" name="percentClassReplace" value='#(..EscapeHTML(settings.percentClassReplace))#' placeholder="_, __, <empty>, etc."/>
            </div>
        </div>

        <div class="form-group row mb-3 mapping-input-group">
            <div class="col-sm-3">
                <label for="MappingsPath" class="col-form-label"  data-toggle="tooltip" data-placement="top" title="Relative paths mapping the files in your project">Mappings</label>
                <button type="button" class="btn btn-default btn-add" >
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#198754" class="bi bi-plus-circle-fill" viewBox="0 0 16 16">
                        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"></path>
                    </svg>
                </button>
            </div>
            <script language="cache" runat=server>
                set extKey = ""
                set idx = 1
                for {
                    set covKey = ""
                    set extKey = $ORDER(settings.Mappings(extKey))
                    quit:extKey=""
                    for {
                        set covKey = $ORDER(settings.Mappings(extKey, covKey))
                        quit:covKey=""

                        if (idx '= 1) {
                            &html<<div class="col-sm-3" id="indent-div">
                            </div>>
                        }                        

                        if ($data(settings.Mappings(extKey, covKey, "NoFolders")) = 1){
                            set checked = ""
                            set activated = ""
                            set mapPath = settings.Mappings(extKey, covKey)
                            set noFolders = """NoFolders"""
                            set tooltipTitle = """Switch on to store files in folders split by '.'s in the name."""                            
                        } else {
                            set checked = "checked"
                            set activated = " active"
                            set mapPath = settings.Mappings(extKey, covKey)
                            set noFolders = """"""
                            set tooltipTitle = """Switch off to store files in a flat directory structure."""
                        }

                        &html<<div class="voca col-sm-7">
                            <div class = "input-group mb-1">
                                <input type="text" class="form-control" id="MappingsExt" name="MappingsExt" value=#(extKey)# placeholder="Extension">
                                <input type="text" class="form-control" id="MappingsCov" name="MappingsCov" value=#(covKey)# placeholder="Coverage">
                                <input type="text" class="form-control" id="MappingsPath" name="MappingsPath" value=#(mapPath)# placeholder="Relative path">
                                <input type="text" class="form-control" id="NoFolders" name="NoFolders" value=#(noFolders)# placeholder="To folder, or not to folder, that is the question." readonly>
                                <div class="custom-control custom-switch" data-delay='{"show":"1000", "hide":"100"}' data-toggle="tooltip" data-placement="top" title=#(tooltipTitle)#>
                                    <input type="checkbox" class="#("custom-control-input"_activated)#" id=#("noFoldersSwitch"_idx)# #(checked)#>
                                    <label class="custom-control-label" for=#("noFoldersSwitch"_idx)#>>

                                    if (checked '= ""){
                                        &html<<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#007bff" class="bi bi-folder-fill" viewBox="0 0 16 16">
                                            <path d="M9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.825a2 2 0 0 1-1.991-1.819l-.637-7a1.99 1.99 0 0 1 .342-1.31L.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3zm-8.322.12C1.72 3.042 1.95 3 2.19 3h5.396l-.707-.707A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139z"/>
                                        </svg>>                                        
                                    } else{
                                        &html<<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-folder-x" viewBox="0 0 16 16">
                                            <path d="M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h3.982a2 2 0 0 1 1.992 2.181L15.546 8H14.54l.265-2.91A1 1 0 0 0 13.81 4H2.19a1 1 0 0 0-.996 1.09l.637 7a1 1 0 0 0 .995.91H9v1H2.826a2 2 0 0 1-1.991-1.819l-.637-7a1.99 1.99 0 0 1 .342-1.31zm6.339-1.577A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139C1.72 3.042 1.95 3 2.19 3h5.396l-.707-.707z"/>
                                            <path d="M11.854 10.146a.5.5 0 0 0-.707.708L12.293 12l-1.146 1.146a.5.5 0 0 0 .707.708L13 12.707l1.146 1.147a.5.5 0 0 0 .708-.708L13.707 12l1.147-1.146a.5.5 0 0 0-.707-.708L13 11.293l-1.146-1.147z"/>
                                        </svg>>
                                    }
                                    
                                    &html<</label>
                                </div>
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-remove" >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#dc3545" class="bi bi-dash-circle-fill" viewBox="0 0 16 16">
                                            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM4.5 7.5a.5.5 0 0 0 0 1h7a.5.5 0 0 0 0-1h-7z"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>>

                        set idx = idx + 1
                    }
                }
            </script>        
        </div>


        <br/>
        <h3>Settings for user '#(..EscapeHTML($Username))#'</h3>
        <em>Git settings - if empty, will default to repository/global settings</em>
        <br/><br/><br/>

        <div class="form-group row mb-3">
            <label for="gitUserName" class="col-sm-3 col-form-label"  data-toggle="tooltip" data-placement="top" title="Firstname Lastname">Git Committer Name </label>
            <div class="col-sm-7">
                <input type="text" class="form-control" id="gitUserName" name="gitUserName" value='#(..EscapeHTML(settings.gitUserName))#'/>
            </div>
        </div>

        <div class="form-group row mb-3">
            <label for="gitUserEmail" class="col-sm-3 col-form-label"  data-toggle="tooltip" data-placement="top" title="<git-username-on-remote>@remote.com">Git Committer Email </label>
            <div class="col-sm-7">
                <input type="email" class="form-control" id="gitUserEmail" name="gitUserEmail" value='#(..EscapeHTML(settings.gitUserEmail))#'/>
            </div>
        </div>

        <br/><br/>

        <div class="form-group row mb-3">
            <div class="col-sm-12 text-center">
                <input type='submit' class="btn-lg btn-primary" value = 'Save'/>
            </div>
        </div>
        
    </form>
    <csp:if condition='$D(%request.Data("gitsettings",1)) && (##class(SourceControl.Git.Utils).NeedSettings() = 0)'>
        <em>Settings saved. Click cross in the upper-right corner to close the settings window.</em>
    </csp:if>
</div>
<script src="js/polyfills.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script type="text/javascript">

$(function () {
    $('[data-toggle="tooltip"]').tooltip({
        trigger: 'hover'
    });
});
$(function()
{
    $(document).on('click', '.btn-add', function(e)
    {
        e.preventDefault();

        var controlForm = $('.mapping-input-group');
        $('<div class="col-sm-3" id="indent-div"> </div>').appendTo(controlForm);

        var currentEntry = $(this).parent().siblings('.voca:last');
        var newEntry = $(currentEntry.clone())

        var currentID = newEntry.children().children(".custom-control").children()[0].id
        var idx = parseInt(currentID.split("noFoldersSwitch")[1]);
        var newID = "noFoldersSwitch"+(idx+1);

        $(newEntry.children().children(".custom-control").children()[1]).attr("for", newID)
        newEntry.children().children(".custom-control").children()[0].id = newID
        newEntry.find('input').val('');

        newEntry.appendTo(controlForm);
        $(("#"+newID)).click(toggleNoFolders);
        
    }).on('click', '.btn-remove', function(e)
    {
        $(this).parent().parent().parent().prev('#indent-div').remove();
        $(this).parents('.voca:first').remove();

        e.preventDefault();
        return false;
    });

    $(document).on('click', "#goToWebUI", function(e){
        e.preventDefault();
        console.log($("#webuiURL")[0].innerText);
        window.location.replace($("#webuiURL")[0].innerText);
    })
});

function toggleNoFolders(e){
    $(this).siblings("label").empty()

    if (!$(this).hasClass("active")) {
        $(this).addClass("active");
        $(this).siblings("label").append('<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#007bff" class="bi bi-folder-fill" viewBox="0 0 16 16">'+
                                        '<path d="M9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.825a2 2 0 0 1-1.991-1.819l-.637-7a1.99 1.99 0 0 1 .342-1.31L.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3zm-8.322.12C1.72 3.042 1.95 3 2.19 3h5.396l-.707-.707A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139z"/>'+
                                    '</svg>');
        
        $(this).parent().siblings("#NoFolders")[0].value = ""
        $(this).parent().attr('data-original-title', 'Switch off to store files in a flat directory structure.');
    } else {
        $(this).removeClass("active");
        $(this).siblings("label").append('<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-folder-x" viewBox="0 0 16 16">'+
                                        '<path d="M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h3.982a2 2 0 0 1 1.992 2.181L15.546 8H14.54l.265-2.91A1 1 0 0 0 13.81 4H2.19a1 1 0 0 0-.996 1.09l.637 7a1 1 0 0 0 .995.91H9v1H2.826a2 2 0 0 1-1.991-1.819l-.637-7a1.99 1.99 0 0 1 .342-1.31zm6.339-1.577A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139C1.72 3.042 1.95 3 2.19 3h5.396l-.707-.707z"/>'+
                                        '<path d="M11.854 10.146a.5.5 0 0 0-.707.708L12.293 12l-1.146 1.146a.5.5 0 0 0 .707.708L13 12.707l1.146 1.147a.5.5 0 0 0 .708-.708L13.707 12l1.147-1.146a.5.5 0 0 0-.707-.708L13 11.293l-1.146-1.147z"/>'+
                                    '</svg>');  

        $(this).parent().siblings("#NoFolders")[0].value = "NoFolders";
         $(this).parent().attr('data-original-title', "Switch on to store files in folders split by the '.' s in the name.");
    }
}

$('[id^=noFoldersSwitch]').click(toggleNoFolders);

</script>
</body>
</html>
<script method='OnPreHTTP' language='cache' runat='server' returntype='%Boolean'>	
	try {
		if (%request.UserAgent [ " Code/") {
			// Workaround for VSCode webview
			set %session.SessionScope = 0 // none; allowed because...
			set %session.SecureSessionCookie = 1 // secure flag on session cookie - will be ignored over http, but that's OK because we already have it
		}
	} catch e {
		// ignore; may occur on platform versions without the above properties
	}
	quit 1
</script>