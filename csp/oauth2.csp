<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HTTPS OAuth Configuration</title>
<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
<link rel="stylesheet" type="text/css" href="css/git-webui.css" />
<style type='text/css'>

body {
    font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
    font-size: 1rem;
    font-weight: 350;
    line-height: 1.5;
    color: #212529;
    text-align: left;
}

.alert {
  padding: 20px;
  background-color: #04AA6D;;
  color: white;
}

.closebtn {
  margin-left: 15px;
  color: white;
  font-weight: bold;
  float: right;
  font-size: 22px;
  line-height: 20px;
  cursor: pointer;
  transition: 0.3s;
}

.closebtn:hover {
  color: black;
}
</style>
</head>
<body>
<server>
	set authenticated = 0
	if $Data(%request.Data("state",1),state)#2 {
		// Redirected here from github
		// switch to the namespace that the extension is installed to
		set namespace = $Piece(state,"_",1)
		new $Namespace
		set $Namespace = namespace

		set config = ##class(SourceControl.Git.OAuth2.Config).GetConfig($username)
		if (config.state '= state){
			w "Invalid State"
			quit 1
		}

		if '$Data(%request.Data("code",1),code)#2 {
			w "Bad request: Invalid parameters"
			quit 1
		}

		set verifier = config.verifier

		set result = config.Exchange(code, verifier, .sc)
		if sc '= $$$OK {
			do SYSTEM.Status.DisplayError(sc) 
			w "<br>"
			w "Unable to retreive access token"
		} else {
			do ##class(SourceControl.Git.Util.CredentialManager).SetToken($username,result, .err, .code)
			if (code '= 1) || (err '= "") {
				w "Unable to save credential"
			} else {
				set authenticated = 1
			}
		}


		// https://docs.intersystems.com/irislatest/csp/docbook/DocBook.UI.Page.cls?KEY=GNET_http

	}
	set namespace = $NAMESPACE
	set username = $USERNAME
	set config = ##class(SourceControl.Git.OAuth2.Config).GetConfig(username)
	set authCodeURL = ""
	set ready = ""
	/// After submit
	if (%request.Method="POST") && $Data(%request.Data("oauthsettings",1)) {
		set ready = 1
		set clientID = $Get(%request.Data("clientID",1))
		set clientSecret = $Get(%request.Data("clientSecret",1))
		set authURL = $Get(%request.Data("authURL",1))
		set tokenURL = $Get(%request.Data("tokenURL",1))
		set redirect = ##class(SourceControl.Git.OAuth2).GetOAuthRedirectEndpoint()

		if config = "" {
			set config = ##class(SourceControl.Git.OAuth2.Config).%New(username, clientID, clientSecret,authURL,tokenURL,redirect)
		} else {
			set config.ClientID = clientID
			set config.ClientSecret = clientSecret
			set config.Endpoint.AuthURL = authURL
			set config.Endpoint.TokenURL = tokenURL
			set config.RedirectURL = redirect
		}

		do config.%Save()

		set authCodeURL = ##class(SourceControl.Git.OAuth2).AuthCodeURL(config,namespace,.state,.verifier)
		set config.state = state
		set config.verifier = verifier
		do config.%Save()
	}
</server>
<div class = 'container'>

	<csp:if condition='(authenticated = 1)'>
        <div class = "alert">
        <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>  
        <strong>Success!</strong> You have been authenticated.
    </div>
    </csp:if>
	<form id="oauthForm" method="post">
		<input type="hidden" name="oauthsettings" value="1" />
		<div class="form-group row mb-3">
            <label for="clientID" class="offset-sm-1 col-sm-3 col-form-label"  data-toggle="tooltip" data-placement="top" title="Github/gitlab ClientID">ClientID<br/></label>
            <div class="col-sm-7">
				<server>
					set clientID = $select(config:config.ClientID, 1: "")
				</server>
                <input type="text" class="form-control" id="clientID" name="clientID" value='#(..EscapeHTML(clientID))#'/>
            </div>
        </div>

		<div class="form-group row mb-3">
            <label for="clientSecret" class="offset-sm-1 col-sm-3 col-form-label"  data-toggle="tooltip" data-placement="top" title="Github/gitlab Client Secret">Client Secret<br/></label>
            <div class="col-sm-7">
				<server>
					set clientSecret = $select(config:config.ClientSecret, 1: "")
				</server>
                <input type="text" class="form-control" id="clientSecret" name="clientSecret" value='#(..EscapeHTML(clientSecret))#'/>
            </div>
        </div>

		<div class="form-group row mb-3">
            <label for="authURL" class="offset-sm-1 col-sm-3 col-form-label"  data-toggle="tooltip" data-placement="top" title="Github/gitlab Authorize URL">Authorize URL<br/></label>
            <div class="col-sm-7">
				<server>
					set authURL = $select(config:config.Endpoint.AuthURL, 1: "")
				</server>
                <input type="text" class="form-control" id="authURL" name="authURL" value='#(..EscapeHTML(authURL))#'/>
            </div>
        </div>

		<div class="form-group row mb-3">
            <label for="tokenURL" class="offset-sm-1 col-sm-3 col-form-label"  data-toggle="tooltip" data-placement="top" title="Github/gitlab Token URL">Token URL<br/></label>
            <div class="col-sm-7">
				<server>
					set tokenURL = $select(config:config.Endpoint.TokenURL, 1: "")
				</server>
                <input type="text" class="form-control" id="tokenURL" name="tokenURL" value='#(..EscapeHTML(tokenURL))#'/>
            </div>
        </div>

		<div class="form-group row mb-3">
            <div class="col-sm-12 text-center">
                <input type="hidden" id="proxySubmitButton" name="proxySubmitButton" value="Save">
                <input type='submit' class="btn-lg btn-primary" value = 'Save' name="Authorize"/>
            </div>
        </div>

	</form>
	<csp:if condition='ready'>
    	<a href="#(authCodeURL)#" target="_blank" rel="noopener noreferrer">Click Here</a>
	</csp:if>

	
</div>
<script src="js/polyfills.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script type="text/javascript">

	var submitForm = function(e) {
		e.preventDefault();
		e.stopPropagation();
		var form = document.getElementById('oauthForm');
		form.submit();
	}
</script>
</body>
</html>